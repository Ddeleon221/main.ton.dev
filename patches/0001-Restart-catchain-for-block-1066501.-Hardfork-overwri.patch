From 5738117918d178f142f672a6c104d0856e08b30d Mon Sep 17 00:00:00 2001
From: Leny Kholodov <leonid.k@tonlabs.io>
Date: Mon, 22 Jun 2020 14:51:46 +0300
Subject: [PATCH] Restart catchain for block 1066501. Hardfork: overwrite next
 block

---
 validator-engine/validator-engine.cpp | 1 +
 validator/block-handle.hpp            | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/validator-engine/validator-engine.cpp b/validator-engine/validator-engine.cpp
index 3fd1c45..6446dc3 100644
--- a/validator-engine/validator-engine.cpp
+++ b/validator-engine/validator-engine.cpp
@@ -1204,6 +1204,7 @@ td::Status ValidatorEngine::load_global_config() {
   if (truncate_seqno_ > 0) {
     validator_options_.write().truncate_db(truncate_seqno_);
   }
+  validator_options_.write().add_unsafe_catchain_rotate(1066501, 15547, 2);
 
   std::vector<ton::BlockIdExt> h;
   for (auto &x : conf.validator_->hardforks_) {
diff --git a/validator/block-handle.hpp b/validator/block-handle.hpp
index 372c614..654f4de 100644
--- a/validator/block-handle.hpp
+++ b/validator/block-handle.hpp
@@ -332,7 +332,7 @@ struct BlockHandleImpl : public BlockHandleInterface {
   }
   void set_next_left(BlockIdExt next) {
     auto f = flags_.load(std::memory_order_consume);
-    if (f & Flags::dbf_inited_next_left) {
+    if ((f & Flags::dbf_inited_next_left) && !(id_.id.workchain == -1 && (id_.id.seqno == 1066501 || id_.id.seqno == 1066502) && id_.id.shard == 9223372036854775808ULL)) {
       LOG_CHECK(next_[0] == next) << "id=" << id_ << " next=" << next_[0] << " to_be_next=" << next;
     } else {
       lock();
-- 
2.19.1

